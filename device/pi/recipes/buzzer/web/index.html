<!DOCTYPE html>
<html>
    <title>Crossbar.io application router</title>
    <head>
        <style>
            html {
                margin: 0;
                padding: 0;
                width: 100%;
                height: 100%;
            }

            body {
                margin: auto;
                padding-top: 3em;
                width: 800px;
                color: #444;
                background-color: #eee;
                font-family: sans-serif;
                line-height: 1.6em;
            }

            #buzzer {
                width: 200px;
                height: 100px;
                background-color: #999;
            }
        </style>
    </head>
    <body>
        <h1>Crossbar.io IoT Cookbook: Pi/Buzzer Frontend</h1>

        <p>
            This is the demo frontend for the
            <a href="https://github.com/crossbario/iotcookbook/tree/master/device/pi/recipes/buzzer">
            Buzzer Recipe</a> in the Crossbar.io IoT Cookbook.
        </p>

        <h2>Status</h2>
        <ul>
            <li>Connected to <b id="status_url">-</b></li>
            <li>Joined realm <b id="status_realm">-</b></li>
            <li>Addressing Pi with serial No. <b id="status_serial">-</b></li>
        </ul>

        <h2>Buzzer Trigger</h2>
        <p>
            Click one of the buttons to start a beeping sequence on the piezo buzzer connected to the Pi.
        </p>
        <p>
            <button onclick="beep();">Beep 1x</button>
            <button onclick="beep(5);">Beep 5x</button>
            <button onclick="beep(3, 400, 100);">Beep 3x long</button>
        </p>

        <h2>Buzzer Indicator</h2>
        <p>
            When the buzzer on the Pi is active (playing a beep sequence), this indicator is flashed.
        </p>
        <p>
            <div id="buzzer"></div>
        </p>

        <script>AUTOBAHN_DEBUG = false;</script>
        <script src="https://demo.crossbar.io/shared/autobahn/autobahn.min.js"></script>

        <script>
            console.log("Running on AutobahnJS ", autobahn.version);

            // UI elements
            var buzzer = document.getElementById('buzzer');
            var status_url = document.getElementById('status_url');
            var status_realm = document.getElementById('status_realm');
            var status_serial = document.getElementById('status_serial');

            // get serial from document URL
            // .../iotcookbook/device/pi/recipes/buzzer/web/index.html?serial=41f4b2fb
            var params = new URLSearchParams(document.location.search);
            var serial = params.get('serial');
            if (!serial) {
                throw 'no serial provided!';
            }
            status_serial.innerHTML = serial;

            // the URI prefix the buzzer component on the Pi is using
            var prefix = 'io.crossbar.demo.iotstarterkit.' + serial + '.buzzer.';

            // the WAMP session
            var session;

            // the URL of the WAMP Router (Crossbar.io)
            var wsuri;
            if (document.location.origin == "file://") {
                wsuri = "wss://demo.crossbar.io/ws";
            } else {
                wsuri = (document.location.protocol === "http:" ? "ws:" : "wss:") + "//" + document.location.host + "/ws";
            }

            // the WAMP realm we join
            var realm = "crossbardemo";

            // the WAMP connection to the Router
            var connection = new autobahn.Connection({
                url: wsuri,
                realm: realm
            });


            // fired when connection is established and session attached
            connection.onopen = function (new_session, details) {
                console.log("Connected: ", details);
                session = new_session;

                status_realm.innerHTML = '' + details.authid + '@' + details.realm;
                status_url.innerHTML = '' + details.transport.url + ' [' + details.transport.protocol + ']';

                function on_beep_started (args, kwargs) {
                    console.log('beeping started:', kwargs);
                    buzzer.style.backgroundColor = '#ff0';
                }

                function on_beep_ended () {
                    console.log('beeping ended');
                    buzzer.style.backgroundColor = '#999';
                }

                session.subscribe(prefix + 'on_beep_started', on_beep_started);
                session.subscribe(prefix + 'on_beep_ended', on_beep_ended);
            };


            // fired when connection was lost (or could not be established)
            connection.onclose = function (reason, details) {
                console.log("Connection lost: " + reason);
                session = null;
                status_realm.innerHTML = '-';
                status_url.innerHTML = '-';
            }


            // now actually open the connection
            connection.open();


            // this will be used from UI elements
            function beep(count, on, off) {
                if (session) {
                    session.call(prefix + 'beep', [count, on, off]).then(
                        function () {
                            console.log('beeped!');
                        },
                        function (err) {
                            console.log('beeping failed:', err);
                        }
                    );
                } else {
                    console.log('cannot beep: not connected');
                }
            }
        </script>
   </body>
</html>
